<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Ads Frame</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .loading {
            text-align: center;
            color: #fff;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error {
            background: #ff4444;
            color: #fff;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }
        .close-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            z-index: 999999;
            display: none;
        }
    </style>
</head>
<body>
    <button class="close-btn" id="closeBtn" onclick="closeAd()">‚úï</button>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading ad...</div>
    </div>
    <div class="error" id="error" style="display:none;">
        <div style="font-size:24px;margin-bottom:10px;">‚ö†Ô∏è</div>
        <div id="errorText">Error loading ad</div>
        <button onclick="closeAd()" style="margin-top:15px;padding:10px 30px;border:none;border-radius:8px;background:#fff;color:#333;font-weight:600;cursor:pointer;">Close</button>
    </div>

    <div id="debug" style="position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.9);color:#0f0;font-family:monospace;font-size:11px;padding:10px;max-height:200px;overflow-y:auto;z-index:999999;"></div>
    
    <script>
        // ============== DEBUG LOGGER ==============
        const debugEl = document.getElementById('debug');
        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f55' : type === 'success' ? '#5f5' : '#0ff';
            const line = `<div style="color:${color}">[${time}] ${msg}</div>`;
            debugEl.innerHTML += line;
            debugEl.scrollTop = debugEl.scrollHeight;
            console.log(`[AdFrame ${type}]`, msg);
        }
        
        // ============== CONFIG ==============
        const NYGMA_BLOCK_ID = "s1av3y3phfqnuwnihtphpst9";
        const ADEXIUM_WID = "3d27f8a6-9ace-4037-9f44-8a25c2da7ccc";
        const TADS_WIDGET_ID = "1016";
        
        // Get provider from URL
        const params = new URLSearchParams(window.location.search);
        const provider = params.get('provider');
        const parentOrigin = params.get('origin') || '*';
        
        log('üöÄ AdFrame initialized');
        log('Provider: ' + provider);
        log('Parent origin: ' + parentOrigin);
        log('Current URL: ' + window.location.href);

        // ============== COMMUNICATION ==============
        function sendToParent(type, data = {}) {
            window.parent.postMessage({ type, provider, ...data }, parentOrigin);
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('errorText').textContent = message;
            sendToParent('adError', { error: message });
        }

        function closeAd() {
            sendToParent('adClosed');
        }

        function adComplete(reward = {}) {
            sendToParent('adComplete', { reward });
        }

        function showCloseButton() {
            document.getElementById('closeBtn').style.display = 'block';
        }

        // ============== SCRIPT LOADER ==============
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${src}"]`)) {
                    return resolve();
                }
                const s = document.createElement('script');
                s.src = src;
                s.async = true;
                s.onload = resolve;
                s.onerror = () => reject(new Error('Failed to load: ' + src));
                document.body.appendChild(s);
            });
        }

        // ============== ADSONAR ==============
        async function showAdSonar() {
            try {
                log('üì• Loading AdSonar script...');
                await loadScript('https://static.sonartech.io/lib/1.0.0/sonar.js?appId=app_033fe3d0');
                log('‚úÖ AdSonar script loaded', 'success');
                
                // Wait for Sonar
                let waited = 0;
                while (!window.Sonar && waited < 5000) {
                    await new Promise(r => setTimeout(r, 100));
                    waited += 100;
                }
                
                if (!window.Sonar) {
                    log('‚ùå window.Sonar not available after 5s', 'error');
                    throw new Error('AdSonar not loaded');
                }
                
                log('üéØ window.Sonar available, calling show()...');
                document.getElementById('loading').style.display = 'none';
                const result = await window.Sonar.show({ adUnit: 'default', loader: true });
                
                log('üìã AdSonar result: ' + JSON.stringify(result));
                
                if (result && (result.status === 'showing' || result.status === 'success' || result.status === 'completed')) {
                    log('‚úÖ AdSonar completed successfully', 'success');
                    adComplete({ amount: 100, item: 'coins', provider: 'adsonar' });
                } else {
                    log('‚ö†Ô∏è AdSonar status: ' + (result?.status || 'no ad'), 'error');
                    showError('AdSonar: ' + (result?.status || 'no ad'));
                }
            } catch (e) {
                log('‚ùå AdSonar error: ' + e.message, 'error');
                showError('AdSonar error: ' + e.message);
            }
        }

        // ============== ADEXIUM ==============
        async function showAdexium() {
            try {
                log('üì• Loading Adexium script...');
                await loadScript('https://cdn.adexium.tech/assets/js/adexium-widget.min.js');
                log('‚úÖ Adexium script loaded', 'success');
                
                let waited = 0;
                while (!window.AdexiumWidget && waited < 5000) {
                    await new Promise(r => setTimeout(r, 100));
                    waited += 100;
                }
                
                if (!window.AdexiumWidget) {
                    log('‚ùå window.AdexiumWidget not available', 'error');
                    throw new Error('Adexium not loaded');
                }
                
                log('üéØ Creating AdexiumWidget with WID: ' + ADEXIUM_WID);
                document.getElementById('loading').style.display = 'none';
                
                const adexiumAds = new window.AdexiumWidget({
                    wid: ADEXIUM_WID,
                    adFormat: "interstitial",
                    debug: true
                });

                let resolved = false;

                adexiumAds.on("adReceived", (ad) => {
                    log('üì¶ Adexium adReceived: ' + JSON.stringify(ad));
                    adexiumAds.displayAd(ad);
                });

                adexiumAds.on("adDisplayed", () => {
                    log('‚úÖ Adexium adDisplayed', 'success');
                    if (resolved) return;
                    resolved = true;
                    adComplete({ amount: 100, item: 'coins', provider: 'adexium' });
                });

                adexiumAds.on("noAdFound", () => {
                    log('‚ö†Ô∏è Adexium noAdFound', 'error');
                    if (resolved) return;
                    resolved = true;
                    showError('Adexium: no ad found');
                });

                adexiumAds.on("adError", (error) => {
                    log('‚ùå Adexium adError: ' + error, 'error');
                    if (resolved) return;
                    resolved = true;
                    showError('Adexium error: ' + error);
                });

                setTimeout(() => {
                    if (!resolved) {
                        log('‚è∞ Adexium timeout after 15s', 'error');
                        resolved = true;
                        showError('Adexium timeout');
                    }
                }, 15000);

                log('üöÄ Calling adexiumAds.requestAd("interstitial")...');
                adexiumAds.requestAd("interstitial");
            } catch (e) {
                log('‚ùå Adexium error: ' + e.message, 'error');
                showError('Adexium error: ' + e.message);
            }
        }

        // ============== NYGMA ==============
        async function showNygma() {
            try {
                log('üì• Loading Nygma script...');
                await loadScript('https://static.nigma.smbadmin.tech/sdk/index.min.js');
                log('‚úÖ Nygma script loaded', 'success');
                
                let waited = 0;
                while (!window.NigmaSDK && waited < 5000) {
                    await new Promise(r => setTimeout(r, 100));
                    waited += 100;
                }
                
                if (!window.NigmaSDK) {
                    log('‚ùå window.NigmaSDK not available', 'error');
                    throw new Error('Nygma not loaded');
                }
                
                log('üéØ Initializing NigmaSDK with blockId: ' + NYGMA_BLOCK_ID);
                document.getElementById('loading').style.display = 'none';
                
                const controller = window.NigmaSDK.init({ blockId: NYGMA_BLOCK_ID });
                log('üìã NigmaSDK controller created: ' + JSON.stringify(Object.keys(controller)));
                
                log('üöÄ Calling controller.showAd()...');
                const result = await controller.showAd();
                
                log('‚úÖ Nygma result: ' + JSON.stringify(result), 'success');
                adComplete({ amount: 100, item: 'coins', provider: 'nygma' });
            } catch (e) {
                log('‚ùå Nygma error: ' + e.message, 'error');
                showError('Nygma error: ' + e.message);
            }
        }

        // ============== TADS ==============
        async function showTADS() {
            try {
                log('üì• Loading TADS script...');
                await loadScript('https://unpkg.com/react-tads-widget@latest/dist/index.umd.js');
                log('‚úÖ TADS script loaded', 'success');
                
                let waited = 0;
                while (!window.renderTadsWidget && waited < 5000) {
                    await new Promise(r => setTimeout(r, 100));
                    waited += 100;
                }
                
                if (!window.renderTadsWidget) {
                    log('‚ùå window.renderTadsWidget not available', 'error');
                    throw new Error('TADS not loaded');
                }
                
                log('üéØ TADS ready, widget ID: ' + TADS_WIDGET_ID);
                document.getElementById('loading').style.display = 'none';
                
                let resolved = false;
                
                window.__tadsCallbacks = {
                    onShowReward: () => {
                        log('‚úÖ TADS onShowReward called', 'success');
                        if (resolved) return;
                        resolved = true;
                        adComplete({ amount: 100, item: 'coins', provider: 'tads' });
                    },
                    onAdsNotFound: () => {
                        log('‚ö†Ô∏è TADS onAdsNotFound called', 'error');
                        if (resolved) return;
                        resolved = true;
                        showError('TADS: no ads found');
                    }
                };
                
                log('üöÄ Calling renderTadsWidget...');
                window.renderTadsWidget({
                    id: TADS_WIDGET_ID,
                    type: 'fullscreen'
                });
                
                setTimeout(() => {
                    if (!resolved) {
                        log('‚è∞ TADS timeout after 15s', 'error');
                        resolved = true;
                        showError('TADS timeout');
                    }
                }, 15000);
            } catch (e) {
                log('‚ùå TADS error: ' + e.message, 'error');
                showError('TADS error: ' + e.message);
            }
        }

        // ============== INIT ==============
        async function init() {
            log('üèÅ init() called');
            
            if (!provider) {
                log('‚ùå No provider in URL params', 'error');
                showError('No provider specified');
                return;
            }
            
            log('üì§ Sending adStarted to parent...');
            sendToParent('adStarted');
            
            log('üé¨ Starting provider: ' + provider);
            
            try {
                switch (provider) {
                    case 'adsonar':
                        await showAdSonar();
                        break;
                    case 'adexium':
                        await showAdexium();
                        break;
                    case 'nygma':
                    case 'nigma':
                        await showNygma();
                        break;
                    case 'tads':
                        await showTADS();
                        break;
                    default:
                        log('‚ùå Unknown provider: ' + provider, 'error');
                        showError('Unknown provider: ' + provider);
                }
            } catch (e) {
                log('‚ùå Unhandled error in init: ' + e.message, 'error');
                showError('Error: ' + e.message);
            }
        }

        // Start
        log('‚ö° Starting init...');
        init();
    </script>
</body>
</html>
